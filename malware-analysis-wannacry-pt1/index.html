

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>Malware Analysis : WannaCry (part 1) - Blog - hashp4</title><meta name="Description" content="Personal blog"><meta property="og:title" content="Malware Analysis : WannaCry (part 1)" />
<meta property="og:description" content="Walkthrough of my malware analysis for the Bossfight challenge from the Practical Malware Analysis &amp; Triage course created by @HuskyHacks. This time, I dive into the infamous WannaCry, a great challenge to apply everything I&rsquo;ve learnt from now on !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hashp4.fr/malware-analysis-wannacry-pt1/" /><meta property="og:image" content="https://hashp4.fr/malware-analysis-wannacry-pt1/feature.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-26T22:00:53+01:00" />
<meta property="article:modified_time" content="2023-11-26T22:00:53+01:00" /><meta property="og:site_name" content="hashp4" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://hashp4.fr/malware-analysis-wannacry-pt1/feature.png" /><meta name="twitter:title" content="Malware Analysis : WannaCry (part 1)"/>
<meta name="twitter:description" content="Walkthrough of my malware analysis for the Bossfight challenge from the Practical Malware Analysis &amp; Triage course created by @HuskyHacks. This time, I dive into the infamous WannaCry, a great challenge to apply everything I&rsquo;ve learnt from now on !"/>
<meta name="twitter:site" content="@hashp4_"/>
<meta name="application-name" content="hashp4">
<meta name="apple-mobile-web-app-title" content="hashp4">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><meta name="twitter:creator" content="@hashp4_" /><link rel="icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://hashp4.fr/malware-analysis-wannacry-pt1/" /><link rel="prev" href="https://hashp4.fr/malware-analysis-sikomode/" /><link rel="next" href="https://hashp4.fr/fcsc-2019-3615-incident-1/" />
<link rel="stylesheet" href="/css/main.d5cb6f29e0750a13b17688d628b04d50f9fbbd32e0629ccc0dcf796a299ae226.css" integrity="sha256-1ctvKeB1ChOxdojWKLBNUPn7vTLgYpzMDc95aima4iY="><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/color.b0a0f8c429ce52dfa2805b5f9e99ccdae1e8fbfd9adf4f3ddb409d8201fc0c5a.css" integrity="sha256-sKD4xCnOUt&#43;igFtfnpnM2uHo&#43;/2a308920CdggH8DFo="><link rel="stylesheet" href="/css/style.min.aadeb0d1e0db9fd05aaaa62285215f80238b1e906367e8936725dd7de8c1642f.css" integrity="sha256-qt6w0eDbn9BaqqYihSFfgCOLHpBjZ&#43;iTZyXdfejBZC8="><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Malware Analysis : WannaCry (part 1)",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://hashp4.fr/malware-analysis-wannacry-pt1/"
        },"image": ["https://hashp4.fr/images/Apple-Devices-Preview.png"],"genre": "posts","keywords": "Malware, PMAT, WannaCry, Cutter, x64dbg, Procmon","wordcount":  2721 ,
        "url": "https://hashp4.fr/malware-analysis-wannacry-pt1/","datePublished": "2023-11-26T22:00:53+01:00","dateModified": "2023-11-26T22:00:53+01:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "hashp4","logo": {
                    "@type": "ImageObject",
                    "url": "https://hashp4.fr/images/logo.png",
                    "width":  288 ,
                    "height":  288 
                }},"authors": [{
                        "@type": "Person",
                        "name": "hashp4"                    
                    }],"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('black' === 'light' || 'black' === 'dark' || 'black' === 'black') setTheme('black'), saveTheme('black'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Blog - hashp4"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/whoami">ðŸ‡«ðŸ‡· whoami </a><a class="menu-item" href="/categories/article/">âœ’ Blog </a><a class="menu-item" href="/projects/">ðŸ“š Projects </a><a class="menu-item" href="/categories/writeup/">ðŸš© Writeups </a><a class="menu-item" href="/music/">ðŸŽµ Music </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" title="Select Language" id="language-select-desktop" onchange="location = this.value;"><option value="/malware-analysis-wannacry-pt1/" selected>English</option></select>
                    </a><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="Switch Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="black">Black</option>
                        <option value="auto">Auto</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Blog - hashp4"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/whoami" title="">ðŸ‡«ðŸ‡·whoami</a><a class="menu-item" href="/categories/article/" title="">âœ’Blog</a><a class="menu-item" href="/projects/" title="">ðŸ“šProjects</a><a class="menu-item" href="/categories/writeup/" title="">ðŸš©Writeups</a><a class="menu-item" href="/music/" title="">ðŸŽµMusic</a><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="Switch Theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="black">Black</option>
                    <option value="auto">Auto</option>
                </select>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" title="Select Language" onchange="location = this.value;"><option value="/malware-analysis-wannacry-pt1/" selected>English</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#objective">Objective</a></li>
    <li><a href="#tools">Tools</a>
      <ul>
        <li><a href="#basic-analysis">Basic Analysis</a></li>
        <li><a href="#advanced-analysis">Advanced Analysis</a></li>
      </ul>
    </li>
    <li><a href="#basic-facts">Basic Facts</a></li>
    <li><a href="#challenge-questions">Challenge Questions</a>
      <ul>
        <li>
          <ul>
            <li><a href="#record-any-observed-symptoms-of-infection-from-initial-detonation-what-are-the-main-symptoms-of-a-wannacry-infection">Record any observed symptoms of infection from initial detonation. What are the main symptoms of a WannaCry infection?</a></li>
            <li><a href="#use-floss-and-extract-the-strings-from-the-main-wannacry-binary-are-there-any-strings-of-interest">Use FLOSS and extract the strings from the main WannaCry binary. Are there any strings of interest?</a></li>
            <li><a href="#inspect-the-import-address-table-for-the-main-wannacry-binary-are-there-any-notable-api-imports">Inspect the import address table for the main WannaCry binary. Are there any notable API imports?</a></li>
            <li><a href="#what-conditions-are-necessary-to-get-this-sample-to-detonate">What conditions are necessary to get this sample to detonate?</a></li>
            <li><a href="#network-indicators-identify-the-network-indicators-of-this-malware">Network Indicators: Identify the network indicators of this malware</a></li>
            <li><a href="#host-based-indicators-identify-the-host-based-indicators-of-this-malware">Host-based Indicators: Identify the host-based indicators of this malware.</a></li>
            <li><a href="#use-cutter-to-locate-the-killswitch-mechanism-in-the-decompiled-code-and-explain-how-it-functions">Use Cutter to locate the killswitch mechanism in the decompiled code and explain how it functions.</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#yara-rule">YARA Rule</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Malware Analysis : WannaCry (part 1)</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class='author'><span class="author fas fa-user-circle fa-fw"></span><span class='screen-reader-text'>  </span><a href='https://hashp4.fr/authors/hashp4'>hashp4</a></span>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/article/"><i class="far fa-folder fa-fw"></i>Article</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-11-26">2023-11-26</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2023-11-26">2023-11-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2721 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;13 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        
        loading="eager"
        src="/malware-analysis-wannacry-pt1/feature.png"
        srcset="/malware-analysis-wannacry-pt1/feature.png, /malware-analysis-wannacry-pt1/feature.png 1.5x, /malware-analysis-wannacry-pt1/feature.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/feature.png"
        title="/malware-analysis-wannacry-pt1/feature.png" height="360"   width="1200" ></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#objective">Objective</a></li>
    <li><a href="#tools">Tools</a>
      <ul>
        <li><a href="#basic-analysis">Basic Analysis</a></li>
        <li><a href="#advanced-analysis">Advanced Analysis</a></li>
      </ul>
    </li>
    <li><a href="#basic-facts">Basic Facts</a></li>
    <li><a href="#challenge-questions">Challenge Questions</a>
      <ul>
        <li>
          <ul>
            <li><a href="#record-any-observed-symptoms-of-infection-from-initial-detonation-what-are-the-main-symptoms-of-a-wannacry-infection">Record any observed symptoms of infection from initial detonation. What are the main symptoms of a WannaCry infection?</a></li>
            <li><a href="#use-floss-and-extract-the-strings-from-the-main-wannacry-binary-are-there-any-strings-of-interest">Use FLOSS and extract the strings from the main WannaCry binary. Are there any strings of interest?</a></li>
            <li><a href="#inspect-the-import-address-table-for-the-main-wannacry-binary-are-there-any-notable-api-imports">Inspect the import address table for the main WannaCry binary. Are there any notable API imports?</a></li>
            <li><a href="#what-conditions-are-necessary-to-get-this-sample-to-detonate">What conditions are necessary to get this sample to detonate?</a></li>
            <li><a href="#network-indicators-identify-the-network-indicators-of-this-malware">Network Indicators: Identify the network indicators of this malware</a></li>
            <li><a href="#host-based-indicators-identify-the-host-based-indicators-of-this-malware">Host-based Indicators: Identify the host-based indicators of this malware.</a></li>
            <li><a href="#use-cutter-to-locate-the-killswitch-mechanism-in-the-decompiled-code-and-explain-how-it-functions">Use Cutter to locate the killswitch mechanism in the decompiled code and explain how it functions.</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#yara-rule">YARA Rule</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/wannacry-logo.webp"
        srcset="/malware-analysis-wannacry-pt1/img/wannacry-logo.webp, /malware-analysis-wannacry-pt1/img/wannacry-logo.webp 1.5x, /malware-analysis-wannacry-pt1/img/wannacry-logo.webp 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/wannacry-logo.webp"
        title="/malware-analysis-wannacry-pt1/img/wannacry-logo.webp" height="895"   width="1200" ></figure></p>
<table>
<thead>
<tr>
<th>Difficulty</th>
<th>Start Date &amp; Time</th>
<th>Finish Date &amp; Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>Medium</td>
<td>24/11/2023 - 16h45</td>
<td>26/11/2023 - 19h30</td>
</tr>
</tbody>
</table>
<h2 id="introduction" class="headerLink">
    <a href="#introduction" class="header-mark"></a>Introduction</h2><p>In the early summer of 2017, WannaCry was unleashed on the world. Widely considered to be one of the most devastating malware infections to date, WannaCry left a trail of destruction in its wake. WannaCry is a classic ransomware sample; more specifically, it is a ransomware cryptoworm, which means that it can encrypt individual hosts and had the capability to propagate through a network on its own.</p>
<p>(<em>If you want more information about WannaCry, I strongly recommand you to listen to Darknet Diaries&rsquo;s podcast on the subject: <a href="https://darknetdiaries.com/episode/73/" target="_blank" rel="noopener noreferrer">https://darknetdiaries.com/episode/73/</a></em>)</p>
<hr>
<h2 id="objective" class="headerLink">
    <a href="#objective" class="header-mark"></a>Objective</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Perform a full analysis of WannaCry and answer the questions below.
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="tools" class="headerLink">
    <a href="#tools" class="header-mark"></a>Tools</h2><h3 id="basic-analysis" class="headerLink">
    <a href="#basic-analysis" class="header-mark"></a>Basic Analysis</h3><ul>
<li>File hashes</li>
<li>VirusTotal</li>
<li>FLOSS</li>
<li>PEStudio</li>
<li>PEView</li>
<li>Wireshark</li>
<li>Inetsim</li>
<li>TCPView</li>
<li>Procmon</li>
</ul>
<h3 id="advanced-analysis" class="headerLink">
    <a href="#advanced-analysis" class="header-mark"></a>Advanced Analysis</h3><ul>
<li>Cutter</li>
<li>Debugger (x64dbg)</li>
</ul>
<hr>
<h2 id="basic-facts" class="headerLink">
    <a href="#basic-facts" class="header-mark"></a>Basic Facts</h2><p><strong>SHA256:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>MD5:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">db349b97c37d22f5ea1d1841e3c89eb4
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>VirusTotal:</strong></p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/vt-analysis.png"
        srcset="/malware-analysis-wannacry-pt1/img/vt-analysis.png, /malware-analysis-wannacry-pt1/img/vt-analysis.png 1.5x, /malware-analysis-wannacry-pt1/img/vt-analysis.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/vt-analysis.png"
        title="/malware-analysis-wannacry-pt1/img/vt-analysis.png" height="837"   width="1966" ></figure></p>
<p>Obviously, the file was flagged as malicious. It&rsquo;s flagged by 70 security vendors and the most popular threat label is <code>wannacry</code>. I might as well tell you that it&rsquo;s spotted miles away. But for the purpose of this challenge, I won&rsquo;t take it in consideration in order to find everything by myself, as if I was the first person to be infected by WannaCry ðŸ˜¼! How lucky&hellip;</p>
<hr>
<h2 id="challenge-questions" class="headerLink">
    <a href="#challenge-questions" class="header-mark"></a>Challenge Questions</h2><h4 id="record-any-observed-symptoms-of-infection-from-initial-detonation-what-are-the-main-symptoms-of-a-wannacry-infection" class="headerLink">
    <a href="#record-any-observed-symptoms-of-infection-from-initial-detonation-what-are-the-main-symptoms-of-a-wannacry-infection" class="header-mark"></a>Record any observed symptoms of infection from initial detonation. What are the main symptoms of a WannaCry infection?</h4><p>When detonating WannaCry for the first time, I noticed several symptoms of infection.</p>
<ol>
<li>
<p>Different files were created or modified</p>
<ul>
<li>
<p><code>@Please_Read_Me@.txt</code>: it contains a brief explanation of what happened and the instructions on how to fix it (i.e how to pay the ransom and get my files decrypted).</p>
</li>
<li>
<p><code>@WanaDecryptor@.exe</code>: . this is the binary in charge of decrypting my files when the ransom will be paid. In the meantime, it gives different informations (<em>detailed below</em>). I  also noticed that most of my executable files were modified to <code>@WanaDecryptor@.exe</code>. Below you will find a screenshot of the associated window.</p>
</li>
<li>
<p><code>@WanaDecryptor@.exe.lnk</code>: this is a shortcut to <code>@WanaDecryptor@.exe</code>. I noticed that most of my shortcuts were modified to point on it.</p>
</li>
<li>
<p><code>@WanaDecryptor@.bmp</code>: this is the new desktop wallpaper that will be replacing .</p>
</li>
<li>
<p><code>[filename].WNCRY</code>: I noticed most of my files were encrypted and their name appended with this extension.</p>
</li>
</ul>
</li>
<li>
<p>The desktop background has been replaced by this âœ¨cuteâœ¨ message :</p>
</li>
</ol>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/symptoms-1.png"
        srcset="/malware-analysis-wannacry-pt1/img/symptoms-1.png, /malware-analysis-wannacry-pt1/img/symptoms-1.png 1.5x, /malware-analysis-wannacry-pt1/img/symptoms-1.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/symptoms-1.png"
        title="/malware-analysis-wannacry-pt1/img/symptoms-1.png" height="877"   width="1587" ></figure></p>
<ol start="3">
<li>The following pop-up window appeared. It can be spawned manually by executing <code>@WanaDecryptor@.exe</code>.</li>
</ol>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/pop-up-wanadecryptor.png"
        srcset="/malware-analysis-wannacry-pt1/img/pop-up-wanadecryptor.png, /malware-analysis-wannacry-pt1/img/pop-up-wanadecryptor.png 1.5x, /malware-analysis-wannacry-pt1/img/pop-up-wanadecryptor.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/pop-up-wanadecryptor.png"
        title="/malware-analysis-wannacry-pt1/img/pop-up-wanadecryptor.png" height="1033"   width="1656" ></figure></p>
<p>I can see a lot of informations.</p>
<p><strong>On the left</strong></p>
<ul>
<li>when will the payment be raised on,</li>
<li>when my files will be lost on,</li>
<li>what is bitcoin and how to buy it.</li>
</ul>
<p><strong>In the main window</strong></p>
<ul>
<li>informations on what happened to my computer,</li>
<li>informations on how to recover my files,</li>
<li>informations on how to pay</li>
<li>contact details.</li>
</ul>
<p><strong>On the bottom</strong></p>
<ul>
<li>the amount in dollars of the ransom,</li>
<li>the bitcoin address to which payment should be sent,</li>
<li>a <em>Check Payment</em> button,</li>
<li>a <em>Decrypt</em> button.</li>
</ul>
<hr>
<h4 id="use-floss-and-extract-the-strings-from-the-main-wannacry-binary-are-there-any-strings-of-interest" class="headerLink">
    <a href="#use-floss-and-extract-the-strings-from-the-main-wannacry-binary-are-there-any-strings-of-interest" class="header-mark"></a>Use FLOSS and extract the strings from the main WannaCry binary. Are there any strings of interest?</h4><p>Using FLOSS, I  extracted several interesting strings from the main WannaCry binary. First of all I noticed the following :</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/interesting-strings-2.png"
        srcset="/malware-analysis-wannacry-pt1/img/interesting-strings-2.png, /malware-analysis-wannacry-pt1/img/interesting-strings-2.png 1.5x, /malware-analysis-wannacry-pt1/img/interesting-strings-2.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/interesting-strings-2.png"
        title="/malware-analysis-wannacry-pt1/img/interesting-strings-2.png" height="237"   width="719" ></figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">C:\%s\qeriuwjhrf
</span></span><span class="line"><span class="cl">tasksche.exe
</span></span><span class="line"><span class="cl">http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first string is an absolute path to a file. At this point, I have no idea of what it could be but its name is composed of random letters probably to hide its real meaning and  purpose. The second string is the name of an EXE file (<code>tasksche.exe</code>) similar to the official one for the <code>Task Scheduler</code> which is <code>taskschd.exe</code> ðŸ¤”. The third string is an URL to a strange website composed of random characters. It&rsquo;s probably used later during the execution of the malware.</p>
<p>Then, I noticed some more interesting strings associated to cryptography and command execution.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/interesting-string-3.png"
        srcset="/malware-analysis-wannacry-pt1/img/interesting-string-3.png, /malware-analysis-wannacry-pt1/img/interesting-string-3.png 1.5x, /malware-analysis-wannacry-pt1/img/interesting-string-3.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/interesting-string-3.png"
        title="/malware-analysis-wannacry-pt1/img/interesting-string-3.png" height="446"   width="663" ></figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CryptGenKey
</span></span><span class="line"><span class="cl">CryptDecrypt
</span></span><span class="line"><span class="cl">CryptEncrypt
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cmd.exe /c &#34;%s&#34;
</span></span><span class="line"><span class="cl">icacls . /grant Everyone:F /T /C /Q
</span></span><span class="line"><span class="cl">attrib +h .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">WNcry@2o17
</span></span></code></pre></td></tr></table>
</div>
</div><p>It looks like this malware is using cryptographic functions from the header <code>wincrypt.h</code>, probably to encrypt files. Also, I can see some system commands like <code>cmd.exe /c</code> or <code>icacls</code> related to file and directory access control lists. and <code>attrib +h .</code> which is setting the hidden file attribute. Additionnally, I noticed the string <code>WNcry@2o17</code>. I don&rsquo;t know what is its purpose but from my perspective it looks like a password or something like that.</p>
<p>I also noticed UNC (<em>Universal Naming Convention</em>) paths. This is a mean to specify location of network resources in the context of a LAN.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/interesting-string-4.png"
        srcset="/malware-analysis-wannacry-pt1/img/interesting-string-4.png, /malware-analysis-wannacry-pt1/img/interesting-string-4.png 1.5x, /malware-analysis-wannacry-pt1/img/interesting-string-4.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/interesting-string-4.png"
        title="/malware-analysis-wannacry-pt1/img/interesting-string-4.png" height="213"   width="287" ></figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">\\172.16.99.5\IPC$
</span></span><span class="line"><span class="cl">\\192.168.56.20\IPC$
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">WanaCrypt0r
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here, both of the UNC paths are leading to the <code>IPC$</code> share. Microsoft officially state :</p>
<blockquote>
<p>&ldquo;<em>The IPC$ share is also known as a null session connection. By using this session, Windows lets anonymous users perform certain activities, such as enumerating the names of domain accounts and network shares.</em>&rdquo;</p>
</blockquote>
<p>So WannaCry is probably enumerating systems for specific informations it needs.</p>
<p><code>WanaCrypt0r</code> is also a string that attracted my attention. I suppose it&rsquo;s probably the name of a function or a binary.</p>
<p>Finally, these are the last couple of strings I noticed.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/interesting-strings-smb.png"
        srcset="/malware-analysis-wannacry-pt1/img/interesting-strings-smb.png, /malware-analysis-wannacry-pt1/img/interesting-strings-smb.png 1.5x, /malware-analysis-wannacry-pt1/img/interesting-strings-smb.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/interesting-strings-smb.png"
        title="/malware-analysis-wannacry-pt1/img/interesting-strings-smb.png" height="462"   width="391" ></figure></p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/interesting-string-5.png"
        srcset="/malware-analysis-wannacry-pt1/img/interesting-string-5.png, /malware-analysis-wannacry-pt1/img/interesting-string-5.png 1.5x, /malware-analysis-wannacry-pt1/img/interesting-string-5.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/interesting-string-5.png"
        title="/malware-analysis-wannacry-pt1/img/interesting-string-5.png" height="551"   width="557" ></figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SMBr
</span></span><span class="line"><span class="cl">SMBs
</span></span><span class="line"><span class="cl">PC NETWORK Program 1.0
</span></span><span class="line"><span class="cl">LAN MAN1.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">6.1.7601.17514 (win7sp1_rtm.101119-1850)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first couple of strings are related to the usage of the SMB (<em>Server Message Block</em>) protocol. It allows sharing resources (files and directories) through the local network between Windows machines. As Microsoft states :</p>
<blockquote>
<p>&ldquo;In the protocol negotiation process, SMB dialects are identified by Dialect Identifier Strings. For example, the <strong>Core Protocol</strong> is identified by two strings: &ldquo;PCLAN1.0&rdquo; or &ldquo;PC NETWORK PROGRAM 1.0&rdquo;. Either or both of these strings can be sent by the client.&rdquo;&quot;</p>
</blockquote>
<p>There&rsquo;s also a long list of file extensions. I suppose this is to know which file to encrypt (or not?), which file to substitute for <code>@WanaDecryptor@.exe</code> or for modifying shortcuts to point to it.</p>
<p>Lastly, there&rsquo;s a string related to a specific build and version of Windows 7. It&rsquo;s probably necessary for WannaCry to have this information (maybe to compare it with the result of its machine enumeration).</p>
<hr>
<h4 id="inspect-the-import-address-table-for-the-main-wannacry-binary-are-there-any-notable-api-imports" class="headerLink">
    <a href="#inspect-the-import-address-table-for-the-main-wannacry-binary-are-there-any-notable-api-imports" class="header-mark"></a>Inspect the import address table for the main WannaCry binary. Are there any notable API imports?</h4><p>To inspect the Import Address Table (<strong>IAT</strong>) for the main WannaCry binary to check if there are any notable API imports, I used <code>PEStudio</code> along with <a href="https://malapi.io/winapi/GetAdaptersInfo" target="_blank" rel="noopener noreferrer">MalAPI</a> to get some more informations about certain functions.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/pestudio-imports.png"
        srcset="/malware-analysis-wannacry-pt1/img/pestudio-imports.png, /malware-analysis-wannacry-pt1/img/pestudio-imports.png 1.5x, /malware-analysis-wannacry-pt1/img/pestudio-imports.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/pestudio-imports.png"
        title="/malware-analysis-wannacry-pt1/img/pestudio-imports.png" height="840"   width="822" ></figure></p>
<p>You can see there&rsquo;s over <strong>91 imports</strong> flagged as suspicious. I won&rsquo;t describe all of them but I&rsquo;ll go through the most interesting ones according to me, which are also related to the strings I found earlier.</p>
<p><strong>CreateServiceA:</strong>
This function is commonly used by malwares for persistence. Basically, its aim is to create a service.</p>
<p><strong>GetAdaptersInfo:</strong>
This function is commonly used by malwares for enumeration purposes. It&rsquo;s probably kind of linked with a few strings I found earlier such as Windows&rsquo;s version or the <code>IPC$</code> share.</p>
<p><strong>InternetOpenA, InternetOpenUrlA &amp; InternetCloseHandle:</strong>
Those functions are associated with malicious internet connectivity. It can be used to download malicious files, exfiltration or to interact with a C2. That&rsquo;s also probably linked with the URL I found in the strings earlier.</p>
<p><strong>CryptGenRandom, CryptAcquireContextA, rand &amp; srand:</strong>
Those are typical cryptographic functions used by ransomwares, mainly to encrypt any type of files.</p>
<p>As I could read the IAT without any troubles, I also took the opportunity to assert this malware wasn&rsquo;t packed. To do so, I used <code>PEView</code> na dcompared the <code>Virtual Size</code> and <code>Size of Raw Data</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/virtual-size-vs-raw-data.png"
        srcset="/malware-analysis-wannacry-pt1/img/virtual-size-vs-raw-data.png, /malware-analysis-wannacry-pt1/img/virtual-size-vs-raw-data.png 1.5x, /malware-analysis-wannacry-pt1/img/virtual-size-vs-raw-data.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/virtual-size-vs-raw-data.png"
        title="/malware-analysis-wannacry-pt1/img/virtual-size-vs-raw-data.png" height="222"   width="911" ></figure></p>
<table>
<thead>
<tr>
<th></th>
<th>Size (in Hex)</th>
<th>Size (in Dec)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Virtual Size</td>
<td>00008BCA</td>
<td>35786</td>
</tr>
<tr>
<td>Size of Raw Data</td>
<td>00009000</td>
<td>36864</td>
</tr>
<tr>
<td>Size Difference</td>
<td>00000436</td>
<td>1078</td>
</tr>
</tbody>
</table>
<p>As you can see, the size difference is small. It means that both sizes are almost equal, resulting in the binary not being packed. But, it looks like there&rsquo;s more in this binary.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/embedded-files.png"
        srcset="/malware-analysis-wannacry-pt1/img/embedded-files.png, /malware-analysis-wannacry-pt1/img/embedded-files.png 1.5x, /malware-analysis-wannacry-pt1/img/embedded-files.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/embedded-files.png"
        title="/malware-analysis-wannacry-pt1/img/embedded-files.png" height="162"   width="1443" ></figure></p>
<p>By looking at the <code>indicators</code> section in <code>PEStudio</code>, it tells me that &ldquo;<em>The file contains another file</em>&rdquo; and gives me the offset of where its located. Interesting. It could be worth taking a look at these further in the analysis.</p>
<hr>
<h4 id="what-conditions-are-necessary-to-get-this-sample-to-detonate" class="headerLink">
    <a href="#what-conditions-are-necessary-to-get-this-sample-to-detonate" class="header-mark"></a>What conditions are necessary to get this sample to detonate?</h4><p>During the first detonation, I had <code>INetSim</code> running on my REMnux machine and quickly noticed that WannaCry would not detonate. However, when I turned off <code>INetSim</code>, it would run without any problems. What I thought was the following :</p>
<blockquote>
<p>Maybe WannaCry can detect INetSim by analysing the answer of the HTTP request ? But if it&rsquo;s the case, it means it can run without any internet connection as my FlareVM is isolated. So what&rsquo;s the point of detecting INetSim ?</p>
</blockquote>
<p>In order to get more answers, I decided to open <code>Cutter</code> and statically analyze it. And I quickly found them in the <code>main</code> function :</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/cutter-openurl.png"
        srcset="/malware-analysis-wannacry-pt1/img/cutter-openurl.png, /malware-analysis-wannacry-pt1/img/cutter-openurl.png 1.5x, /malware-analysis-wannacry-pt1/img/cutter-openurl.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/cutter-openurl.png"
        title="/malware-analysis-wannacry-pt1/img/cutter-openurl.png" height="663"   width="928" ></figure></p>
<p>Here, you can see the URL I found earlier with <code>FLOSS</code>. It&rsquo;s first stored in <code>esi</code> and moved into <code>ecx</code> later on, according to the <code>lea ecx, [var_64h]</code> instruction. The function <code>InternetOpenA</code> is called after its arguments are being pushed onto the stack. It allows to initialize the use of the WinINet functions. Then, the same process is taking place for the <code>InternetOpenUrlA</code> function. Among the arguments, there&rsquo;s the killswitch URL. Indeed, this function opens a resource specified by a HTTP URL and therefore require an URL.</p>
<p>The value returned by the <code>InternetOpenUrlA</code> function, stored in <code>eax</code>, is moved in <code>edi</code>. As it is stated in the <a href="https://learn.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla" target="_blank" rel="noopener noreferrer">Microsoft documentation</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Returns a valid handle to the URL if the connection is successfully established, or NULL if the connection fails.
</span></span></code></pre></td></tr></table>
</div>
</div><p>(Also, the <code>InternetCloseHandle</code> function is called in order to close the Internet handle).</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/cutter-jne-internetopen.png"
        srcset="/malware-analysis-wannacry-pt1/img/cutter-jne-internetopen.png, /malware-analysis-wannacry-pt1/img/cutter-jne-internetopen.png 1.5x, /malware-analysis-wannacry-pt1/img/cutter-jne-internetopen.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/cutter-jne-internetopen.png"
        title="/malware-analysis-wannacry-pt1/img/cutter-jne-internetopen.png" height="320"   width="866" ></figure></p>
<p>The value of <code>edi</code> is then evaluated through the instruction <code>test edi, edi</code>. The instruction <code>jne 0x4081bc</code> will determine if WannaCry will execute its payload or not. If you read my two previous articles, you must know that <code>jne</code> means <code>jump if not zero</code> and checks the value of the <code>ZF</code> register.</p>
<p>If the value in <code>edi</code> <strong>IS</strong> <code>0</code> (i.e if the <code>ZF</code> register is equal to <code>1</code>),  WannaCry will take the left path and execute call its first function <code>fcn.00408090</code> to continue its execution.</p>
<p>If the value in <code>edi</code> <strong>IS NOT</strong> <code>0</code> (i.e if the <code>ZF</code> register is equal to <code>0</code>), WannaCry won&rsquo;t execute any payloads and will exit.</p>
<p>Thanks to static analysis, I now know why having <code>INetSim</code> turned on wouldn&rsquo;t make WannaCry to detonate and I can confirm that the URL we found earlier is basically used as a killswitch for the malware. ^^</p>
<hr>
<h4 id="network-indicators-identify-the-network-indicators-of-this-malware" class="headerLink">
    <a href="#network-indicators-identify-the-network-indicators-of-this-malware" class="header-mark"></a>Network Indicators: Identify the network indicators of this malware</h4><p>In order to identify network indicators associated to this malware, I first used <code>WireShark</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/network-indicator-3.png"
        srcset="/malware-analysis-wannacry-pt1/img/network-indicator-3.png, /malware-analysis-wannacry-pt1/img/network-indicator-3.png 1.5x, /malware-analysis-wannacry-pt1/img/network-indicator-3.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/network-indicator-3.png"
        title="/malware-analysis-wannacry-pt1/img/network-indicator-3.png" height="209"   width="2127" ></figure></p>
<p>As I already showed previously, WannaCry has a killswitch URL to prevent its detonation under certain conditions. Here, you can clearly see its first trying to resolve the domain <code>www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</code>. If there&rsquo;s an answer to its DNS query, it will send an HTTP get request to <code>http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</code>, as we can see on the capture. Somehow, that&rsquo;s all I&rsquo;ve been able to get with <code>Wireshark</code>.</p>
<p>So, in order to find morenetwork indicators, I also used <code>TCPView</code> as Wireshark wasn&rsquo;t showing me everything.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/network-indicator-1.png"
        srcset="/malware-analysis-wannacry-pt1/img/network-indicator-1.png, /malware-analysis-wannacry-pt1/img/network-indicator-1.png 1.5x, /malware-analysis-wannacry-pt1/img/network-indicator-1.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/network-indicator-1.png"
        title="/malware-analysis-wannacry-pt1/img/network-indicator-1.png" height="638"   width="1353" ></figure></p>
<p>By filtering process name, I noticed that WannaCry was sending TCP Syn requests on port 445 to every IP address in the subnet my infected machine is (10.0.0.0/24). What the malware is trying to do is to infect other machines through the use of the SMB protocol, using the <a href="https://www.sentinelone.com/blog/eternalblue-nsa-developed-exploit-just-wont-die/" target="_blank" rel="noopener noreferrer">EternalBlue - MS17-010</a> exploit developped by the NSA. I won&rsquo;t detail how the exploit is working as there&rsquo;s plenty of great article on the subject. But seeing this, I can affirm WannaCry is not only a <strong>ransomware</strong>, but also a <strong>worm</strong>.</p>
<p>Removing the filter on process name made me realize there was another network indicator left out.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/network-indicator-2.png"
        srcset="/malware-analysis-wannacry-pt1/img/network-indicator-2.png, /malware-analysis-wannacry-pt1/img/network-indicator-2.png 1.5x, /malware-analysis-wannacry-pt1/img/network-indicator-2.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/network-indicator-2.png"
        title="/malware-analysis-wannacry-pt1/img/network-indicator-2.png" height="69"   width="1022" ></figure></p>
<p>There&rsquo;s a binary called <code>taskhsvc.exe</code> listening on port <code>9050</code>. As far as I remember and confirmed by checking on <a href="https://www.speedguide.net/port.php?port=9050" target="_blank" rel="noopener noreferrer">SpeedGuide</a>, this port is used by Tor. I opened the process tree in <code>ProcMon</code> to check if it was launched with any specific arguments.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/pstree-taskhsvc.png"
        srcset="/malware-analysis-wannacry-pt1/img/pstree-taskhsvc.png, /malware-analysis-wannacry-pt1/img/pstree-taskhsvc.png 1.5x, /malware-analysis-wannacry-pt1/img/pstree-taskhsvc.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/pstree-taskhsvc.png"
        title="/malware-analysis-wannacry-pt1/img/pstree-taskhsvc.png" height="59"   width="1264" ></figure></p>
<p>By looking at it, I saw that the binary was in a <code>\Tor\</code> directory. Interesting&hellip; So why not check manually in the directory where the binary was launched ?</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/taskhsvc-tor-same-size.png"
        srcset="/malware-analysis-wannacry-pt1/img/taskhsvc-tor-same-size.png, /malware-analysis-wannacry-pt1/img/taskhsvc-tor-same-size.png 1.5x, /malware-analysis-wannacry-pt1/img/taskhsvc-tor-same-size.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/taskhsvc-tor-same-size.png"
        title="/malware-analysis-wannacry-pt1/img/taskhsvc-tor-same-size.png" height="470"   width="1190" ></figure></p>
<p>It&rsquo;s in <code>C:\ProgramData\ebjhnvvejg519\TaskData\Tor</code>. By looking into it, it seems that <code>taskhsvc.exe</code> is just a copy of <code>tor.exe</code>. I quickly checked if they had the same SHA256 hash value.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/sha256-comparison.png"
        srcset="/malware-analysis-wannacry-pt1/img/sha256-comparison.png, /malware-analysis-wannacry-pt1/img/sha256-comparison.png 1.5x, /malware-analysis-wannacry-pt1/img/sha256-comparison.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/sha256-comparison.png"
        title="/malware-analysis-wannacry-pt1/img/sha256-comparison.png" height="180"   width="982" ></figure></p>
<p>And indeed they have. The purpose of making a copy of <code>tor.exe</code> with that name is probably to hide itself and be less evident to spot. Still, I don&rsquo;t really know what&rsquo;s the purpose of launching Tor yet&hellip;</p>
<p>Now that I&rsquo;ve found the network indicators of this malware, let&rsquo;s go through the host-based indicators !</p>
<hr>
<h4 id="host-based-indicators-identify-the-host-based-indicators-of-this-malware" class="headerLink">
    <a href="#host-based-indicators-identify-the-host-based-indicators-of-this-malware" class="header-mark"></a>Host-based Indicators: Identify the host-based indicators of this malware.</h4><p>In order to identify host-based indicators, I only used <code>ProcMon</code>. I started to apply some filters :</p>
<ul>
<li><code>Process Name</code> contains <code>Ransomware.wannacry.exe</code></li>
<li><code>Operation</code> contains <code>CreateFile</code></li>
</ul>
<p>That way, I could quickly spot any files created by WannaCry.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/tasksche-creation.png"
        srcset="/malware-analysis-wannacry-pt1/img/tasksche-creation.png, /malware-analysis-wannacry-pt1/img/tasksche-creation.png 1.5x, /malware-analysis-wannacry-pt1/img/tasksche-creation.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/tasksche-creation.png"
        title="/malware-analysis-wannacry-pt1/img/tasksche-creation.png" height="50"   width="1069" ></figure></p>
<p>I found that <code>tasksche.exe</code> was created in the <code>C:\Windows\</code> directory.</p>
<p>Then, I modified my filters and decided to focus on <code>tasksche.exe</code> to see if it did anything interesting. Spoiler : it does&hellip;</p>
<ul>
<li><code>Process Name</code> contains <code>tasksche.exe</code></li>
<li><code>Operation</code> contains <code>CreateFile</code></li>
</ul>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/focus-on-tasksche.png"
        srcset="/malware-analysis-wannacry-pt1/img/focus-on-tasksche.png, /malware-analysis-wannacry-pt1/img/focus-on-tasksche.png 1.5x, /malware-analysis-wannacry-pt1/img/focus-on-tasksche.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/focus-on-tasksche.png"
        title="/malware-analysis-wannacry-pt1/img/focus-on-tasksche.png" height="26"   width="1144" ></figure></p>
<p>Among all of the operations, I found that it created the directory <code>ebjhnvvejg519</code> in <code>C:\ProgramData</code>. I decided to explore it manually and by looking at its properties, it&rsquo;s a hidden directory. Remember the command I found earlier that would modify a file / directory attribute to make it hidden ? It was meant for this !</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/unpacking-directory.png"
        srcset="/malware-analysis-wannacry-pt1/img/unpacking-directory.png, /malware-analysis-wannacry-pt1/img/unpacking-directory.png 1.5x, /malware-analysis-wannacry-pt1/img/unpacking-directory.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/unpacking-directory.png"
        title="/malware-analysis-wannacry-pt1/img/unpacking-directory.png" height="704"   width="1191" ></figure></p>
<p>At first sight, it looks like this custom directory is used to unpack WannaCry ressources. I notice three two new binaries : <code>taskse.exe</code> and <code>taskdl.exe</code>.</p>
<p>I also noted that the creation of a service occured. By opening the <code>Task Manager</code>, I could confirm it.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/new-service.png"
        srcset="/malware-analysis-wannacry-pt1/img/new-service.png, /malware-analysis-wannacry-pt1/img/new-service.png 1.5x, /malware-analysis-wannacry-pt1/img/new-service.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/new-service.png"
        title="/malware-analysis-wannacry-pt1/img/new-service.png" height="190"   width="784" ></figure>
<figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/service-desc.png"
        srcset="/malware-analysis-wannacry-pt1/img/service-desc.png, /malware-analysis-wannacry-pt1/img/service-desc.png 1.5x, /malware-analysis-wannacry-pt1/img/service-desc.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/service-desc.png"
        title="/malware-analysis-wannacry-pt1/img/service-desc.png" height="260"   width="569" ></figure></p>
<p>A service has been created with the exact same name as the directory (<code>ebjhnvvejg519</code>) and the path to executable is <code>C:\ProgramData\ebjhnvvejg519</code>. What I suppose is that its purpose is to continuously encrypt files on the machine. Everytime the computer will boot or reboot, it&rsquo;ll start and do its encryption job. That&rsquo;s a mechanism of persistence. Indeed, it looks like <code>tasksche.exe</code> is also responsible of encrypting the files as you can see on the screenshot below with two files of mine : <code>cosmo.jpeg</code> and <code>output-floss.txt</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-wannacry-pt1/img/tasksche-encrypt.png"
        srcset="/malware-analysis-wannacry-pt1/img/tasksche-encrypt.png, /malware-analysis-wannacry-pt1/img/tasksche-encrypt.png 1.5x, /malware-analysis-wannacry-pt1/img/tasksche-encrypt.png 2x"
        sizes="auto"
        alt="/malware-analysis-wannacry-pt1/img/tasksche-encrypt.png"
        title="/malware-analysis-wannacry-pt1/img/tasksche-encrypt.png" height="183"   width="1201" ></figure></p>
<p>That conclude the question on host-based indicators.</p>
<hr>
<h4 id="use-cutter-to-locate-the-killswitch-mechanism-in-the-decompiled-code-and-explain-how-it-functions" class="headerLink">
    <a href="#use-cutter-to-locate-the-killswitch-mechanism-in-the-decompiled-code-and-explain-how-it-functions" class="header-mark"></a>Use Cutter to locate the killswitch mechanism in the decompiled code and explain how it functions.</h4><p>Woops, it looks like I already answered that in the question &ldquo;<code>What conditions are necessary to get this sample to detonate?</code>&rdquo;. (:</p>
<hr>
<h2 id="yara-rule" class="headerLink">
    <a href="#yara-rule" class="header-mark"></a>YARA Rule</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">rule WannaCry {
</span></span><span class="line"><span class="cl">   meta:
</span></span><span class="line"><span class="cl">      description = &#34;YARA Rule for WannaCry detection&#34;
</span></span><span class="line"><span class="cl">      author = &#34;hashp4 (and inspired by Florian Roth)&#34;
</span></span><span class="line"><span class="cl">      date = &#34;2023-11-27&#34;
</span></span><span class="line"><span class="cl">      hash = &#34;24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c&#34;
</span></span><span class="line"><span class="cl">   strings:
</span></span><span class="line"><span class="cl">      $string1 = &#34;icacls . /grant Everyone:F /T /C /Q&#34; fullword ascii
</span></span><span class="line"><span class="cl">      $string2 = &#34;tasksche.exe&#34; fullword ascii
</span></span><span class="line"><span class="cl">      $string3 = &#34;attrib +h .&#34; fullword ascii
</span></span><span class="line"><span class="cl">      $string5 = &#34;WNcry@2ol7&#34; fullword ascii
</span></span><span class="line"><span class="cl">      $string6 = &#34;www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com&#34; ascii
</span></span><span class="line"><span class="cl">      $string8 = &#34;C:\\%s\\qeriuwjhrf&#34; fullword ascii
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      $unc1 = &#34;\\\\192.168.56.20\\IPC$&#34; fullword wide
</span></span><span class="line"><span class="cl">      $unc2 = &#34;\\\\172.16.99.5\\IPC$&#34; fullword wide
</span></span><span class="line"><span class="cl">   condition:
</span></span><span class="line"><span class="cl">      ( 1 of ($string*) and 1 of ($unc*) ) and filesize &lt; 10000KB
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="conclusion" class="headerLink">
    <a href="#conclusion" class="header-mark"></a>Conclusion</h2><p>For this course, that was the last question. But I&rsquo;m really interested in how WannaCry is working and I want to explore deeper into this malware. So, this blog post will have a second part to add bonus explanation by answering more questions such as:</p>
<ul>
<li>What is the purpose of the other embedded binaries (Tor included ðŸ¤—)?</li>
<li>How does WannaCry unpack its resources?</li>
<li>How does the encryption mechanism works and takes place?</li>
<li>Is it possible to decrypt the files even if we don&rsquo;t pay the ransom?</li>
</ul>
<p>I hope you enjoyed this blog post and that it could help understand how WannaCry is acting. Do not hesitate to reach me out if you have any questions or if I made any mistakes in defining concepts or using technical terms. I&rsquo;m still a newbie to this domain and I&rsquo;d be happy to have feedbacks from more experienced analysts. ðŸ’œ</p>
<p><em>PS: In a couple of days or weeks, I&rsquo;ll probably start the exam and try to be PJMR</em> (<strong>Practical Junior Malware Researcher</strong>) <em>certified. In the meantime, I will train on different malware samples so I won&rsquo;t be able to go back on WannaCry for some time. ^_~</em></p>
<p>Thanks for reading me and see you soon ! ðŸ‘‹</p>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-11-26</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/malware-analysis-wannacry-pt1/index.md target="_blank" rel="noopener noreferrer">Read markdown</a>
                    </span></div>
            <div class="post-info-share"><button title="Share on Twitter" data-sharer="twitter" data-url="https://hashp4.fr/malware-analysis-wannacry-pt1/" data-title="Malware Analysis : WannaCry (part 1)" data-via="hashp4_" data-hashtags="Malware,PMAT,WannaCry,Cutter,x64dbg,Procmon"><span class="fab fa-twitter fa-fw"></span></button><button title="Share on Linkedin" data-sharer="linkedin" data-url="https://hashp4.fr/malware-analysis-wannacry-pt1/"><span class="fab fa-linkedin fa-fw"></span></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/malware/">Malware</a>,&nbsp;<a href="/tags/pmat/">PMAT</a>,&nbsp;<a href="/tags/wannacry/">WannaCry</a>,&nbsp;<a href="/tags/cutter/">Cutter</a>,&nbsp;<a href="/tags/x64dbg/">x64dbg</a>,&nbsp;<a href="/tags/procmon/">Procmon</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/malware-analysis-sikomode/" class="prev" rel="prev" title="Malware Analysis : SikoMode"><i class="fas fa-angle-left fa-fw"></i>Malware Analysis : SikoMode</a>
            <a href="/fcsc-2019-3615-incident-1/" class="next" rel="next" title="[FCSC 2019] - 3615 Incident (1/3)">[FCSC 2019] - 3615 Incident (1/3)<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.121.2">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="" href="https://www.gnu.org/licenses/gpl-3.0.en.html" target="_blank">GPL-V3</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/copy-tex.min.css"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"data":{"desktop-header-typeit":"hashp4 (\u003eá´—â€¢)","mobile-header-typeit":"hashp4 (\u003eá´—â€¢)"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":false,"left":"$","right":"$"}],"strict":false},"sharerjs":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.2/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/copy-tex.min.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>
