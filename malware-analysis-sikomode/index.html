

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>Malware Analysis : SikoMode - Blog - hashp4</title><meta name="Description" content="Personal blog"><meta property="og:title" content="Malware Analysis : SikoMode" />
<meta property="og:description" content="Walkthrough of my malware analysis for the SikoMode challenge from the Practical Malware Analysis &amp; Triage course created by @HuskyHacks. This time, I dive into advanced static and dynamic analysis using Cutter and x64dbg.&quot;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hashp4.fr/malware-analysis-sikomode/" /><meta property="og:image" content="https://hashp4.fr/malware-analysis-sikomode/feature.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-11-21T00:00:00+00:00" /><meta property="og:site_name" content="hashp4" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://hashp4.fr/malware-analysis-sikomode/feature.png" /><meta name="twitter:title" content="Malware Analysis : SikoMode"/>
<meta name="twitter:description" content="Walkthrough of my malware analysis for the SikoMode challenge from the Practical Malware Analysis &amp; Triage course created by @HuskyHacks. This time, I dive into advanced static and dynamic analysis using Cutter and x64dbg.&quot;"/>
<meta name="twitter:site" content="@hashp4_"/>
<meta name="application-name" content="hashp4">
<meta name="apple-mobile-web-app-title" content="hashp4">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><meta name="twitter:creator" content="@hashp4_" /><link rel="icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://hashp4.fr/malware-analysis-sikomode/" /><link rel="prev" href="https://hashp4.fr/malware-analysis-sillyputty/" /><link rel="next" href="https://hashp4.fr/malware-analysis-wannacry-pt1/" />
<link rel="stylesheet" href="/css/main.d5cb6f29e0750a13b17688d628b04d50f9fbbd32e0629ccc0dcf796a299ae226.css" integrity="sha256-1ctvKeB1ChOxdojWKLBNUPn7vTLgYpzMDc95aima4iY="><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/color.b0a0f8c429ce52dfa2805b5f9e99ccdae1e8fbfd9adf4f3ddb409d8201fc0c5a.css" integrity="sha256-sKD4xCnOUt&#43;igFtfnpnM2uHo&#43;/2a308920CdggH8DFo="><link rel="stylesheet" href="/css/style.min.aadeb0d1e0db9fd05aaaa62285215f80238b1e906367e8936725dd7de8c1642f.css" integrity="sha256-qt6w0eDbn9BaqqYihSFfgCOLHpBjZ&#43;iTZyXdfejBZC8="><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Malware Analysis : SikoMode",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://hashp4.fr/malware-analysis-sikomode/"
        },"image": ["https://hashp4.fr/images/Apple-Devices-Preview.png"],"genre": "posts","keywords": "Malware, PMAT, Cutter, x64dbg","wordcount":  1902 ,
        "url": "https://hashp4.fr/malware-analysis-sikomode/","datePublished": "2023-11-21T00:00:00+00:00","dateModified": "2023-11-21T00:00:00+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "hashp4","logo": {
                    "@type": "ImageObject",
                    "url": "https://hashp4.fr/images/logo.png",
                    "width":  288 ,
                    "height":  288 
                }},"authors": [{
                        "@type": "Person",
                        "name": "hashp4"                    
                    }],"description": ""
    }
    </script></head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('black' === 'light' || 'black' === 'dark' || 'black' === 'black') setTheme('black'), saveTheme('black'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Blog - hashp4"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/whoami">ðŸ‡«ðŸ‡· whoami </a><a class="menu-item" href="/categories/article/">âœ’ Blog </a><a class="menu-item" href="/projects/">ðŸ“š Projects </a><a class="menu-item" href="/categories/writeup/">ðŸš© Writeups </a><a class="menu-item" href="/music/">ðŸŽµ Music </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" title="Select Language" id="language-select-desktop" onchange="location = this.value;"><option value="/malware-analysis-sikomode/" selected>English</option></select>
                    </a><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                    <select class="color-theme-select" id="theme-select-desktop" title="Switch Theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="black">Black</option>
                        <option value="auto">Auto</option>
                    </select>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Blog - hashp4"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/whoami" title="">ðŸ‡«ðŸ‡·whoami</a><a class="menu-item" href="/categories/article/" title="">âœ’Blog</a><a class="menu-item" href="/projects/" title="">ðŸ“šProjects</a><a class="menu-item" href="/categories/writeup/" title="">ðŸš©Writeups</a><a class="menu-item" href="/music/" title="">ðŸŽµMusic</a><a href="javascript:void(0);" class="menu-item theme-select" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
                <select class="color-theme-select" id="theme-select-mobile" title="Switch Theme">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="black">Black</option>
                    <option value="auto">Auto</option>
                </select>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" title="Select Language" onchange="location = this.value;"><option value="/malware-analysis-sikomode/" selected>English</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#instructions">Instructions</a></li>
    <li><a href="#tools">Tools</a>
      <ul>
        <li><a href="#basic-static-analysis">Basic Static Analysis</a></li>
        <li><a href="#advanced-analysis">Advanced Analysis</a></li>
      </ul>
    </li>
    <li><a href="#basic-facts">Basic Facts</a></li>
    <li><a href="#questions">Questions</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-what-language-is-the-binary-written-in">1) What language is the binary written in?</a></li>
            <li><a href="#2-what-is-the-architecture-of-this-binary">2) What is the architecture of this binary?</a></li>
            <li><a href="#3-under-what-conditions-can-you-get-the-binary-to-delete-itself">3) Under what conditions can you get the binary to delete itself?</a></li>
            <li><a href="#4-does-the-binary-persist-if-so-how">4) Does the binary persist? If so, how?</a></li>
            <li><a href="#5-what-is-the-first-callback-domain">5) What is the first callback domain?</a></li>
            <li><a href="#6-under-what-conditions-can-you-get-the-binary-to-exfiltrate-data">6) Under what conditions can you get the binary to exfiltrate data?</a></li>
            <li><a href="#7-what-is-the-exfiltration-domain">7) What is the exfiltration domain?</a></li>
            <li><a href="#8-how-does-exfiltration-take-place">8) How does exfiltration take place?</a></li>
            <li><a href="#9-what-uri-is-used-to-exfiltrate-data">9) What URI is used to exfiltrate data?</a></li>
            <li><a href="#10-what-type-of-data-is-exfiltrated-the-file-is-cosmojpeg-but-how-exactly-is-the-files-data-transmitted">10) What type of data is exfiltrated (the file is cosmo.jpeg, but how exactly is the file&rsquo;s data transmitted?)</a></li>
            <li><a href="#11-what-kind-of-encryption-algorithm-is-in-use">11) What kind of encryption algorithm is in use?</a></li>
            <li><a href="#12-what-key-is-used-to-encrypt-the-data">12) What key is used to encrypt the data?</a></li>
            <li><a href="#13-what-is-the-significance-of-houdini">13) What is the significance of <code>houdini</code>?</a></li>
            <li><a href="#bonus---retrieve-the-file-content">BONUS - Retrieve the file content</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Malware Analysis : SikoMode</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class='author'><span class="author fas fa-user-circle fa-fw"></span><span class='screen-reader-text'>  </span><a href='https://hashp4.fr/authors/hashp4'>hashp4</a></span>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/article/"><i class="far fa-folder fa-fw"></i>Article</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-11-21">2023-11-21</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2023-11-21">2023-11-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1902 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;9 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        
        loading="eager"
        src="/malware-analysis-sikomode/feature.png"
        srcset="/malware-analysis-sikomode/feature.png, /malware-analysis-sikomode/feature.png 1.5x, /malware-analysis-sikomode/feature.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/feature.png"
        title="/malware-analysis-sikomode/feature.png" height="360"   width="1200" ></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#instructions">Instructions</a></li>
    <li><a href="#tools">Tools</a>
      <ul>
        <li><a href="#basic-static-analysis">Basic Static Analysis</a></li>
        <li><a href="#advanced-analysis">Advanced Analysis</a></li>
      </ul>
    </li>
    <li><a href="#basic-facts">Basic Facts</a></li>
    <li><a href="#questions">Questions</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-what-language-is-the-binary-written-in">1) What language is the binary written in?</a></li>
            <li><a href="#2-what-is-the-architecture-of-this-binary">2) What is the architecture of this binary?</a></li>
            <li><a href="#3-under-what-conditions-can-you-get-the-binary-to-delete-itself">3) Under what conditions can you get the binary to delete itself?</a></li>
            <li><a href="#4-does-the-binary-persist-if-so-how">4) Does the binary persist? If so, how?</a></li>
            <li><a href="#5-what-is-the-first-callback-domain">5) What is the first callback domain?</a></li>
            <li><a href="#6-under-what-conditions-can-you-get-the-binary-to-exfiltrate-data">6) Under what conditions can you get the binary to exfiltrate data?</a></li>
            <li><a href="#7-what-is-the-exfiltration-domain">7) What is the exfiltration domain?</a></li>
            <li><a href="#8-how-does-exfiltration-take-place">8) How does exfiltration take place?</a></li>
            <li><a href="#9-what-uri-is-used-to-exfiltrate-data">9) What URI is used to exfiltrate data?</a></li>
            <li><a href="#10-what-type-of-data-is-exfiltrated-the-file-is-cosmojpeg-but-how-exactly-is-the-files-data-transmitted">10) What type of data is exfiltrated (the file is cosmo.jpeg, but how exactly is the file&rsquo;s data transmitted?)</a></li>
            <li><a href="#11-what-kind-of-encryption-algorithm-is-in-use">11) What kind of encryption algorithm is in use?</a></li>
            <li><a href="#12-what-key-is-used-to-encrypt-the-data">12) What key is used to encrypt the data?</a></li>
            <li><a href="#13-what-is-the-significance-of-houdini">13) What is the significance of <code>houdini</code>?</a></li>
            <li><a href="#bonus---retrieve-the-file-content">BONUS - Retrieve the file content</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><table>
<thead>
<tr>
<th>Difficulty</th>
<th>Start Date &amp; Time</th>
<th>Finish Date &amp; Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>Medium</td>
<td>15/11/2023 - 18h00</td>
<td>18/11/2023 - 21h00</td>
</tr>
</tbody>
</table>
<h2 id="instructions" class="headerLink">
    <a href="#instructions" class="header-mark"></a>Instructions</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Analyst,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This specimen came from a poor decision and a link that should not have been clicked on. No surprises there. We need to figure out the extent of what this thing can do. It looks a little advanced.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Perform a full analysis and send us the report when done. We need to go in depth on this one to determine what it is doing, so break out your decompiler and debugger and get to work!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IR Team
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h2 id="tools" class="headerLink">
    <a href="#tools" class="header-mark"></a>Tools</h2><h3 id="basic-static-analysis" class="headerLink">
    <a href="#basic-static-analysis" class="header-mark"></a>Basic Static Analysis</h3><ul>
<li>File hashes</li>
<li>VirusTotal</li>
<li>FLOSS</li>
<li>PEStudio</li>
<li>PEView</li>
<li>Wireshark</li>
<li>Inetsim</li>
<li>Netcat</li>
<li>TCPView</li>
<li>Procmon</li>
</ul>
<h3 id="advanced-analysis" class="headerLink">
    <a href="#advanced-analysis" class="header-mark"></a>Advanced Analysis</h3><ul>
<li>Cutter</li>
<li>Debugger (x64dbg)</li>
</ul>
<hr>
<h2 id="basic-facts" class="headerLink">
    <a href="#basic-facts" class="header-mark"></a>Basic Facts</h2><p>I started by getting the SHA256 of the file and searched for it on VirusTotal.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SHA256: 3ACA2A08CF296F1845D6171958EF0FFD1C8BDFC3E48BDD34A605CB1F7468213E
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/vt-result.png"
        srcset="/malware-analysis-sikomode/img/vt-result.png, /malware-analysis-sikomode/img/vt-result.png 1.5x, /malware-analysis-sikomode/img/vt-result.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/vt-result.png"
        title="/malware-analysis-sikomode/img/vt-result.png" height="912"   width="1999" ></figure></p>
<p>As I thought, the file was flagged as malicious. But for the purpose of this challenge, I didn&rsquo;t take it in consideration in order to find everything by myself, as if the sample was a fresh new one.</p>
<p>I also &ldquo;<code>FLOSSed</code>&rdquo; the binary to find some interesting strings. I searched for common pattern with <code>grep</code> like <code>C:/</code>, <code>http://</code>, <code>.exe</code>, <code>.txt</code>, <code>.com</code> or even <code>.local</code>. This allowed me to find some interesting strings :</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/interesting-string-1.png"
        srcset="/malware-analysis-sikomode/img/interesting-string-1.png, /malware-analysis-sikomode/img/interesting-string-1.png 1.5x, /malware-analysis-sikomode/img/interesting-string-1.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/interesting-string-1.png"
        title="/malware-analysis-sikomode/img/interesting-string-1.png" height="84"   width="370" ></figure></p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/interesting-string-2.png"
        srcset="/malware-analysis-sikomode/img/interesting-string-2.png, /malware-analysis-sikomode/img/interesting-string-2.png 1.5x, /malware-analysis-sikomode/img/interesting-string-2.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/interesting-string-2.png"
        title="/malware-analysis-sikomode/img/interesting-string-2.png" height="108"   width="601" ></figure></p>
<p>Now that the basic tasks are done, let&rsquo;s dissect this binary to see what&rsquo;s inside and how it works ! ðŸ‘½</p>
<hr>
<h2 id="questions" class="headerLink">
    <a href="#questions" class="header-mark"></a>Questions</h2><h4 id="1-what-language-is-the-binary-written-in" class="headerLink">
    <a href="#1-what-language-is-the-binary-written-in" class="header-mark"></a>1) What language is the binary written in?</h4><p>To know what language is the binary written in, I simply loaded it into <code>Cutter</code>. Then on the Dashboard tab, there is plenty of informations including the one I&rsquo;m looking for. As you can see on the screenshot below, the malware has been written in <code>Nim</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/malware-language.png"
        srcset="/malware-analysis-sikomode/img/malware-language.png, /malware-analysis-sikomode/img/malware-language.png 1.5x, /malware-analysis-sikomode/img/malware-language.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/malware-language.png"
        title="/malware-analysis-sikomode/img/malware-language.png" height="514"   width="417" ></figure></p>
<p>As I wasn&rsquo;t very sure about what <code>Nim</code> looked like, I searched some more informations on the Internet. Apparently, Nim was created to be a language as fast as C, as expressive as Python and as extensible as Lisp. Usually, malware authors use C or C++, Visual Basic and even Rust. Why bother using this language ? It&rsquo;s because using a new programming language allow to bypass / avoid anti-malware protections. Indeed, at the beginning of its usage it wasn&rsquo;t known from the AVs. Thus, there wasn&rsquo;t any protections on hosts and it could run without being flagged. Fortunately, this is not the case anymore, to the extent that even legitimate Nim binary are being flagged, making it hard for developpers using this language as I read here: <a href="https://forum.nim-lang.org/t/9850" target="_blank" rel="noopener noreferrer">https://forum.nim-lang.org/t/9850</a>.</p>
<p>Also, when searching for the keyword <code>Nim</code> on Github, the third most popular repository is the <a href="https://github.com/byt3bl33d3r/OffensiveNim" target="_blank" rel="noopener noreferrer">OffensiveNim</a> one. It shows that this language is pretty much used in offensive scenarios.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/nim-search-github.png"
        srcset="/malware-analysis-sikomode/img/nim-search-github.png, /malware-analysis-sikomode/img/nim-search-github.png 1.5x, /malware-analysis-sikomode/img/nim-search-github.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/nim-search-github.png"
        title="/malware-analysis-sikomode/img/nim-search-github.png" height="866"   width="1988" ></figure></p>
<p>It is also possible to know the language by analyzing the strings in the binary. Indeed, when using <code>strings</code> or <code>FLOSS</code>, I saw that a lot of them started by <code>nim</code> like <code>nimMain</code>, <code>nimGetProcAddr</code> and so on.</p>
<hr>
<h4 id="2-what-is-the-architecture-of-this-binary" class="headerLink">
    <a href="#2-what-is-the-architecture-of-this-binary" class="header-mark"></a>2) What is the architecture of this binary?</h4><p>To know what is the architecture of this binary, I opened it in <code>PEStudio</code>. As you can see on the screenshot below, it&rsquo;s <code>64-bits</code>. <code>Cutter</code> was also showing it in the <code>Dashboard</code> tab.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/architecture-binary.png"
        srcset="/malware-analysis-sikomode/img/architecture-binary.png, /malware-analysis-sikomode/img/architecture-binary.png 1.5x, /malware-analysis-sikomode/img/architecture-binary.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/architecture-binary.png"
        title="/malware-analysis-sikomode/img/architecture-binary.png" height="334"   width="1450" ></figure></p>
<hr>
<h4 id="3-under-what-conditions-can-you-get-the-binary-to-delete-itself" class="headerLink">
    <a href="#3-under-what-conditions-can-you-get-the-binary-to-delete-itself" class="header-mark"></a>3) Under what conditions can you get the binary to delete itself?</h4><p>I noticed there was three different conditions under which the binary delete itself.</p>
<ol>
<li>Firstly, it will delete itself if the binary doesn&rsquo;t have access to the internet and can&rsquo;t contact the callback domain. WHat it does is send a TCP request on port 80 to the gateway. Then, there&rsquo;s a DNS request to the domain <code>update.ec12-4-109-278-3-ubuntu20-04.local</code>.</li>
</ol>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/check-if-has-internet.png"
        srcset="/malware-analysis-sikomode/img/check-if-has-internet.png, /malware-analysis-sikomode/img/check-if-has-internet.png 1.5x, /malware-analysis-sikomode/img/check-if-has-internet.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/check-if-has-internet.png"
        title="/malware-analysis-sikomode/img/check-if-has-internet.png" height="35"   width="1652" ></figure>
<figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/dns-req-update.png"
        srcset="/malware-analysis-sikomode/img/dns-req-update.png, /malware-analysis-sikomode/img/dns-req-update.png 1.5x, /malware-analysis-sikomode/img/dns-req-update.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/dns-req-update.png"
        title="/malware-analysis-sikomode/img/dns-req-update.png" height="71"   width="1352" ></figure></p>
<p>If it fails, i.e there&rsquo;s no answers, it delete itself. I can confirm that supposition by inspecting the binary in <code>Cutter</code>. After displaying the graph of the <code>sym.NimMainModule</code> method, I noticed the following condition :</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/checkKillSwitchURL.png"
        srcset="/malware-analysis-sikomode/img/checkKillSwitchURL.png, /malware-analysis-sikomode/img/checkKillSwitchURL.png 1.5x, /malware-analysis-sikomode/img/checkKillSwitchURL.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/checkKillSwitchURL.png"
        title="/malware-analysis-sikomode/img/checkKillSwitchURL.png" height="514"   width="1659" ></figure></p>
<p>On that screenshot, you can see the function <code>checkKillSwitchURL</code> being called. This is the one that will get the binary to send a request to the callback domain. Then there is the instruction <code>test al, al</code> followed by <code>jne</code> which is a conditional jump depending of the value of the <code>ZF</code> register. If it is equal to <code>0</code>, meaning it returns <code>true</code>, it will continue its execution. Otherwise, it will delete itself by calling the <code>houdini</code> function (<em>we will describe it later on, just assume this function is making the binary delete itself</em>)</p>
<ol start="2">
<li>If the internet connection gets interrupted, the binary will also delete itself. I noticed that by stopping <code>INetSim</code> during its execution. But there&rsquo;s also a confirmation in the disassembled code in <code>Cutter</code>.</li>
</ol>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/delete-if-interrupted.png"
        srcset="/malware-analysis-sikomode/img/delete-if-interrupted.png, /malware-analysis-sikomode/img/delete-if-interrupted.png 1.5x, /malware-analysis-sikomode/img/delete-if-interrupted.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/delete-if-interrupted.png"
        title="/malware-analysis-sikomode/img/delete-if-interrupted.png" height="455"   width="1641" ></figure></p>
<p>This is the continuation of the previous screenshot. The <code>checkKillSwitchURL</code> returned <code>true</code> and the execution continues. Here you can see there&rsquo;s again a <code>test</code> instruction followed by a <code>jne</code> instruction. This time, if the <code>ZF</code> regsiter is set to <code>0</code>, it will call <code>houdini</code> and delete itself. Otherwise, it will continue its execution and call the <code>unpackResources</code> and <code>stealStuff</code> functions which is the normal execution of the binary.</p>
<ol start="3">
<li>Thirdly, the binary will delete itself after its normal execution. Aswell as the two previous cases, I can verify that on <code>Cutter</code> :</li>
</ol>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/delete-itself-anyway.png"
        srcset="/malware-analysis-sikomode/img/delete-itself-anyway.png, /malware-analysis-sikomode/img/delete-itself-anyway.png 1.5x, /malware-analysis-sikomode/img/delete-itself-anyway.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/delete-itself-anyway.png"
        title="/malware-analysis-sikomode/img/delete-itself-anyway.png" height="298"   width="1650" ></figure></p>
<p>You can see that in both cases, the binary will call the <code>houdini</code> function, which means it&rsquo;s bound to get rid of itself anyway.</p>
<hr>
<h4 id="4-does-the-binary-persist-if-so-how" class="headerLink">
    <a href="#4-does-the-binary-persist-if-so-how" class="header-mark"></a>4) Does the binary persist? If so, how?</h4><p>During my analysis, I didn&rsquo;t find any persistance mechanism. On the contrary, it seems the binary is deleting itself after it did everything it needed to do (<em>noticed by dynamic analysis in the previous question</em>).</p>
<hr>
<h4 id="5-what-is-the-first-callback-domain" class="headerLink">
    <a href="#5-what-is-the-first-callback-domain" class="header-mark"></a>5) What is the first callback domain?</h4><p>To answer this question, I launched <code>Wireshark</code> and <code>iNetSim</code>. When I detonated the malware, the first thing I noticed was this DNS request followed by an HTTP request to the domain <code>update.ec12-4-109-278-3-ubuntu20-04.local</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/dns-req-update.png"
        srcset="/malware-analysis-sikomode/img/dns-req-update.png, /malware-analysis-sikomode/img/dns-req-update.png 1.5x, /malware-analysis-sikomode/img/dns-req-update.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/dns-req-update.png"
        title="/malware-analysis-sikomode/img/dns-req-update.png" height="71"   width="1352" ></figure></p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/http-request-update.png"
        srcset="/malware-analysis-sikomode/img/http-request-update.png, /malware-analysis-sikomode/img/http-request-update.png 1.5x, /malware-analysis-sikomode/img/http-request-update.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/http-request-update.png"
        title="/malware-analysis-sikomode/img/http-request-update.png" height="179"   width="687" ></figure></p>
<p>So, the first callback domain is <code>update.ec12-4-109-278-3-ubuntu20-04.local</code>.</p>
<hr>
<h4 id="6-under-what-conditions-can-you-get-the-binary-to-exfiltrate-data" class="headerLink">
    <a href="#6-under-what-conditions-can-you-get-the-binary-to-exfiltrate-data" class="header-mark"></a>6) Under what conditions can you get the binary to exfiltrate data?</h4><p>In <strong>question 3</strong>, I demonstrated under which conditions the binary will execute normally. To do so, it first need to be able to contact the callback domain <code>update.ec12-4-109-278-3-ubuntu20-04.local</code>. If successful, it will unpack resources (the key to encrypt the exfiltrated data) and &ldquo;steal stuff&rdquo;. I&rsquo;m not going to dissect 100% of the stealStuff method, but I&rsquo;m still going to give some precision.</p>
<p>It will first <strong>create an handle</strong> to the file <code>cosmo.jpeg</code>, <strong>read it</strong> and <strong>encode it</strong> in <code>base64</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/handle-to-image.png"
        srcset="/malware-analysis-sikomode/img/handle-to-image.png, /malware-analysis-sikomode/img/handle-to-image.png 1.5x, /malware-analysis-sikomode/img/handle-to-image.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/handle-to-image.png"
        title="/malware-analysis-sikomode/img/handle-to-image.png" height="187"   width="759" ></figure></p>
<p>Then, the content gets encrypted using the RC4 algorithm (it will be detailled in question 11).</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/encrypted-in-rc4.png"
        srcset="/malware-analysis-sikomode/img/encrypted-in-rc4.png, /malware-analysis-sikomode/img/encrypted-in-rc4.png 1.5x, /malware-analysis-sikomode/img/encrypted-in-rc4.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/encrypted-in-rc4.png"
        title="/malware-analysis-sikomode/img/encrypted-in-rc4.png" height="121"   width="946" ></figure></p>
<p>Finally, the binary call the necessary functions to create HTTP requests in order to exfiltrate the data.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/new-http-client.png"
        srcset="/malware-analysis-sikomode/img/new-http-client.png, /malware-analysis-sikomode/img/new-http-client.png 1.5x, /malware-analysis-sikomode/img/new-http-client.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/new-http-client.png"
        title="/malware-analysis-sikomode/img/new-http-client.png" height="241"   width="936" ></figure></p>
<hr>
<h4 id="7-what-is-the-exfiltration-domain" class="headerLink">
    <a href="#7-what-is-the-exfiltration-domain" class="header-mark"></a>7) What is the exfiltration domain?</h4><p>To answer this question, I launched <code>Wireshark</code> and <code>iNetSim</code>. I detonated the malware and after a short amount of time, I noticed a DNS request followed by an HTTP request to the domain <code>cdn.altimiter.local</code> with the user agent <code>Nim httpclient/1.6.2</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/dns-request-cnd-altimiter-local.png"
        srcset="/malware-analysis-sikomode/img/dns-request-cnd-altimiter-local.png, /malware-analysis-sikomode/img/dns-request-cnd-altimiter-local.png 1.5x, /malware-analysis-sikomode/img/dns-request-cnd-altimiter-local.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/dns-request-cnd-altimiter-local.png"
        title="/malware-analysis-sikomode/img/dns-request-cnd-altimiter-local.png" height="72"   width="1056" ></figure></p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/http-req-cdn.alimiter.local.png"
        srcset="/malware-analysis-sikomode/img/http-req-cdn.alimiter.local.png, /malware-analysis-sikomode/img/http-req-cdn.alimiter.local.png 1.5x, /malware-analysis-sikomode/img/http-req-cdn.alimiter.local.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/http-req-cdn.alimiter.local.png"
        title="/malware-analysis-sikomode/img/http-req-cdn.alimiter.local.png" height="169"   width="998" ></figure></p>
<p>So, the exfiltration  domain is <code>cdn.altimiter.local</code>.</p>
<hr>
<h4 id="8-how-does-exfiltration-take-place" class="headerLink">
    <a href="#8-how-does-exfiltration-take-place" class="header-mark"></a>8) How does exfiltration take place?</h4><p>To answer this question, I took the same <code>Wireshark</code> capture as previously and analysed it. I saw that several HTTP <code>GET</code> request were taking place. The only difference between them was the value of the <code>post</code> parameter, chaging every new request but its length was always the same.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/exfiltration-example.png"
        srcset="/malware-analysis-sikomode/img/exfiltration-example.png, /malware-analysis-sikomode/img/exfiltration-example.png 1.5x, /malware-analysis-sikomode/img/exfiltration-example.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/exfiltration-example.png"
        title="/malware-analysis-sikomode/img/exfiltration-example.png" height="564"   width="1705" ></figure></p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/data-exfiltration.png"
        srcset="/malware-analysis-sikomode/img/data-exfiltration.png, /malware-analysis-sikomode/img/data-exfiltration.png 1.5x, /malware-analysis-sikomode/img/data-exfiltration.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/data-exfiltration.png"
        title="/malware-analysis-sikomode/img/data-exfiltration.png" height="327"   width="1571" ></figure></p>
<p>By looking at those results, I suppose the data exfiltration is taking place through those <code>GET</code> requests. The content of the file is encrypted and splitted in strings of 125 characters. Then, those strings are passed as the value of the <code>post</code> parameter in HTTP <code>GET</code> requests. Below is an example of the 125 characters strings :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">String 1: 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">A69C1CF68535758244B2337BAFFE38290DEBB01A07FF20919D758DDD480786BE49FDA8851998C6BC34020A6C57E504C48A9B8BD68959C6B7174302E29D84
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">String 2 :
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">B69C0CF68536758144B03372DDDD38291DEBB31925F523A386678EEC5414AF8966D1BCA316ADC6BC30020A6460D404C49A9B8FD6895AC5BF174376CCBBBC
</span></span></code></pre></td></tr></table>
</div>
</div><p>Thanks to <code>ProcMon</code>, I&rsquo;ve been able to understand some of the encryption mechanism phases better. First, the binary seems to use some cryptographic functions from the <code>bcryptprimitives.dll</code></p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/query-bcrypt-primitives.png"
        srcset="/malware-analysis-sikomode/img/query-bcrypt-primitives.png, /malware-analysis-sikomode/img/query-bcrypt-primitives.png 1.5x, /malware-analysis-sikomode/img/query-bcrypt-primitives.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/query-bcrypt-primitives.png"
        title="/malware-analysis-sikomode/img/query-bcrypt-primitives.png" height="112"   width="528" ></figure></p>
<p>Then, the binary create a file in <code>C:/Users/Public/</code> called <code>passwrd.txt</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/passwrd-content.png"
        srcset="/malware-analysis-sikomode/img/passwrd-content.png, /malware-analysis-sikomode/img/passwrd-content.png 1.5x, /malware-analysis-sikomode/img/passwrd-content.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/passwrd-content.png"
        title="/malware-analysis-sikomode/img/passwrd-content.png" height="726"   width="1684" ></figure></p>
<p>So here&rsquo;s my supposition on the different phases of the encryption :</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/exfiltration-proof.png"
        srcset="/malware-analysis-sikomode/img/exfiltration-proof.png, /malware-analysis-sikomode/img/exfiltration-proof.png 1.5x, /malware-analysis-sikomode/img/exfiltration-proof.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/exfiltration-proof.png"
        title="/malware-analysis-sikomode/img/exfiltration-proof.png" height="559"   width="896" ></figure></p>
<p><strong>TL;DR</strong></p>
<ol>
<li>it create the file <code>C:\Users\Public\passwrd.txt</code> and store the key <code>SikoMode</code> inside,</li>
<li>it create a handle to the file it want to exfiltrate,</li>
<li>it encode (base64) and encrypt (RC4) its content,</li>
<li>it is exfiltrated through HTTP <code>GET</code> requests.</li>
</ol>
<hr>
<h4 id="9-what-uri-is-used-to-exfiltrate-data" class="headerLink">
    <a href="#9-what-uri-is-used-to-exfiltrate-data" class="header-mark"></a>9) What URI is used to exfiltrate data?</h4><p>To answer this question, I can use my previously found results :</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/exfiltration-example.png"
        srcset="/malware-analysis-sikomode/img/exfiltration-example.png, /malware-analysis-sikomode/img/exfiltration-example.png 1.5x, /malware-analysis-sikomode/img/exfiltration-example.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/exfiltration-example.png"
        title="/malware-analysis-sikomode/img/exfiltration-example.png" height="564"   width="1705" ></figure></p>
<p>On this <code>Wireshark</code> capture, we can clearly see the URI used to exfiltrate the data : <code>/feed</code> with the paramter <code>post</code>. So, the final exfiltration URI is built like this :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/feed?post=ENCRYPTED_DATA_TO_BE_EXFILTRATED
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="10-what-type-of-data-is-exfiltrated-the-file-is-cosmojpeg-but-how-exactly-is-the-files-data-transmitted" class="headerLink">
    <a href="#10-what-type-of-data-is-exfiltrated-the-file-is-cosmojpeg-but-how-exactly-is-the-files-data-transmitted" class="header-mark"></a>10) What type of data is exfiltrated (the file is cosmo.jpeg, but how exactly is the file&rsquo;s data transmitted?)</h4><p>I&rsquo;ve already covered this subject in the question 3, 6 and 8. ^^</p>
<hr>
<h4 id="11-what-kind-of-encryption-algorithm-is-in-use" class="headerLink">
    <a href="#11-what-kind-of-encryption-algorithm-is-in-use" class="header-mark"></a>11) What kind of encryption algorithm is in use?</h4><p>As I showed previously, the algorithm used to encrypt the data is RC4. You can find more information here: <a href="https://github.com/OHermesJunior/nimRC4" target="_blank" rel="noopener noreferrer">https://github.com/OHermesJunior/nimRC4</a></p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/fromRC4-usage.png"
        srcset="/malware-analysis-sikomode/img/fromRC4-usage.png, /malware-analysis-sikomode/img/fromRC4-usage.png 1.5x, /malware-analysis-sikomode/img/fromRC4-usage.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/fromRC4-usage.png"
        title="/malware-analysis-sikomode/img/fromRC4-usage.png" height="372"   width="1312" ></figure></p>
<p>There&rsquo;s an occurence in the <code>stealStuff</code> method, where the <code>toRC4()</code> function is called. It takes two arguments: the key and the plaintext. In this case, the key is stored in <code>rcx</code> and the plaintext is in <code>rdx</code>. They are then passed to the function as arguments.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/torc4-function.png"
        srcset="/malware-analysis-sikomode/img/torc4-function.png, /malware-analysis-sikomode/img/torc4-function.png 1.5x, /malware-analysis-sikomode/img/torc4-function.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/torc4-function.png"
        title="/malware-analysis-sikomode/img/torc4-function.png" height="126"   width="1004" ></figure></p>
<hr>
<h4 id="12-what-key-is-used-to-encrypt-the-data" class="headerLink">
    <a href="#12-what-key-is-used-to-encrypt-the-data" class="header-mark"></a>12) What key is used to encrypt the data?</h4><p>We saw in <strong>question 8</strong> that the binary unpacks the file <code>passwrd.txt</code> in <code>C:/Users/Public/</code>. Opening the file will give us the key used to encrypt the data</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/passwrd-content-1.png"
        srcset="/malware-analysis-sikomode/img/passwrd-content-1.png, /malware-analysis-sikomode/img/passwrd-content-1.png 1.5x, /malware-analysis-sikomode/img/passwrd-content-1.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/passwrd-content-1.png"
        title="/malware-analysis-sikomode/img/passwrd-content-1.png" height="126"   width="838" ></figure></p>
<p>As you can see on this screenshot, the key is <code>SikoMode</code>. But there&rsquo;s another way to recover the key by using a debugger. The first thing I did was to get the address of the <code>toRC4()</code> function and its arguments (<em>framed in red</em>).</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/get-rc4-address-for-debugging.png"
        srcset="/malware-analysis-sikomode/img/get-rc4-address-for-debugging.png, /malware-analysis-sikomode/img/get-rc4-address-for-debugging.png 1.5x, /malware-analysis-sikomode/img/get-rc4-address-for-debugging.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/get-rc4-address-for-debugging.png"
        title="/malware-analysis-sikomode/img/get-rc4-address-for-debugging.png" height="162"   width="1453" ></figure></p>
<p>Then, I opened the binary in <code>x64dbg</code> and placed a breakpoint a few lines before the call of the function (here at the address <code>0x00417547</code>). Stepping into twice, right-clicking the <code>mov rcx, rbx</code> instruction and following it in dump shows us the string in the dump.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/retrieve-key-by-debugging.png"
        srcset="/malware-analysis-sikomode/img/retrieve-key-by-debugging.png, /malware-analysis-sikomode/img/retrieve-key-by-debugging.png 1.5x, /malware-analysis-sikomode/img/retrieve-key-by-debugging.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/retrieve-key-by-debugging.png"
        title="/malware-analysis-sikomode/img/retrieve-key-by-debugging.png" height="862"   width="2120" ></figure></p>
<p>As you can see, the key <code>SikoMode</code> can also be retrieved this way.</p>
<hr>
<h4 id="13-what-is-the-significance-of-houdini" class="headerLink">
    <a href="#13-what-is-the-significance-of-houdini" class="header-mark"></a>13) What is the significance of <code>houdini</code>?</h4><p><code>houdini</code> is a method aimed to make the binary delete itself (<em>determined through the dynamic analysis</em>). In the previous questions, I showed it was being called multiple times in the binary.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/houdini-method.png"
        srcset="/malware-analysis-sikomode/img/houdini-method.png, /malware-analysis-sikomode/img/houdini-method.png 1.5x, /malware-analysis-sikomode/img/houdini-method.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/houdini-method.png"
        title="/malware-analysis-sikomode/img/houdini-method.png" height="84"   width="680" ></figure></p>
<hr>
<h4 id="bonus---retrieve-the-file-content" class="headerLink">
    <a href="#bonus---retrieve-the-file-content" class="header-mark"></a>BONUS - Retrieve the file content</h4><p>I wanted to see if I could retrieve the content of the file being exfiltrated as I knew everything to do so. That said, the original <code>cosmo.jpeg</code> file was too heavy and took to long to exfiltrate entierely. Thus, I replaced the original file by mine. I just wrote <code>This is a test</code> inside a file and called it <code>cosmo.jpeg</code>.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/cosmo-substitute.png"
        srcset="/malware-analysis-sikomode/img/cosmo-substitute.png, /malware-analysis-sikomode/img/cosmo-substitute.png 1.5x, /malware-analysis-sikomode/img/cosmo-substitute.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/cosmo-substitute.png"
        title="/malware-analysis-sikomode/img/cosmo-substitute.png" height="510"   width="735" ></figure></p>
<p>It worked and the malware started exfiltrating its content. It took only one request to do so, which was more convenient for me. (:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GET /feed?post=A19A35C7A70E76B366883052A0F22B043F99A066
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then, I wrote a <em>very simple</em> Nim script to decrypt and decode the content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nim" data-lang="nim"><span class="line"><span class="cl"><span class="kn">import</span> <span class="n">RC4</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="n">std</span><span class="o">/</span><span class="n">base64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="n">decryptedString</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="n">fromRC4</span><span class="p">(</span><span class="s">&#34;SikoMode&#34;</span><span class="p">,</span> <span class="s">&#34;A19A35C7A70E76B366883052A0F22B043F99A066&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">echo</span> <span class="s">&#34;Decrypted: &#34;</span><span class="p">,</span> <span class="n">decryptedString</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="n">decodedString</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="n">decode</span><span class="p">(</span><span class="n">decryptedString</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">echo</span> <span class="s">&#34;Decoded: &#34;</span><span class="p">,</span> <span class="n">decodedString</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then, I just had to run it in order to retrieve the content.</p>
<p><figure><img
        
        loading="lazy"
        src="/malware-analysis-sikomode/img/getdata-nim.png"
        srcset="/malware-analysis-sikomode/img/getdata-nim.png, /malware-analysis-sikomode/img/getdata-nim.png 1.5x, /malware-analysis-sikomode/img/getdata-nim.png 2x"
        sizes="auto"
        alt="/malware-analysis-sikomode/img/getdata-nim.png"
        title="/malware-analysis-sikomode/img/getdata-nim.png" height="79"   width="507" ></figure></p>
<p>And it worked !</p>
<p>If you&rsquo;re patient enough, you can try with the original file. Just start a Wireshark capture and wait for the file to be completely exfiltrated (the binary will delete itself when it&rsquo;s done). Then, extract the content of all the HTTP GET requests (using <code>tshark</code> for example) and use <code>sed</code> to remove the URI part from the content. Finally, you&rsquo;ll just have to replace the <code>plaintext</code> with yours in the Nim script above to retrieve Matt&rsquo;s cat. :)</p>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-11-21</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/malware-analysis-sikomode/index.md target="_blank" rel="noopener noreferrer">Read markdown</a>
                    </span></div>
            <div class="post-info-share"><button title="Share on Twitter" data-sharer="twitter" data-url="https://hashp4.fr/malware-analysis-sikomode/" data-title="Malware Analysis : SikoMode" data-via="hashp4_" data-hashtags="Malware,PMAT,Cutter,x64dbg"><span class="fab fa-twitter fa-fw"></span></button><button title="Share on Linkedin" data-sharer="linkedin" data-url="https://hashp4.fr/malware-analysis-sikomode/"><span class="fab fa-linkedin fa-fw"></span></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/malware/">Malware</a>,&nbsp;<a href="/tags/pmat/">PMAT</a>,&nbsp;<a href="/tags/cutter/">Cutter</a>,&nbsp;<a href="/tags/x64dbg/">x64dbg</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/malware-analysis-sillyputty/" class="prev" rel="prev" title="Malware Analysis : SillyPutty"><i class="fas fa-angle-left fa-fw"></i>Malware Analysis : SillyPutty</a>
            <a href="/malware-analysis-wannacry-pt1/" class="next" rel="next" title="Malware Analysis : WannaCry (part 1)">Malware Analysis : WannaCry (part 1)<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.121.2">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer"></a></span>&nbsp;|&nbsp;<span class="license"><a rel="" href="https://www.gnu.org/licenses/gpl-3.0.en.html" target="_blank">GPL-V3</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/copy-tex.min.css"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"data":{"desktop-header-typeit":"hashp4 (\u003eá´—â€¢)","mobile-header-typeit":"hashp4 (\u003eá´—â€¢)"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":false,"left":"$","right":"$"}],"strict":false},"sharerjs":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.2/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/copy-tex.min.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>
